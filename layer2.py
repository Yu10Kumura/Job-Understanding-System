"""
ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘¡: æ¥­ç•Œæ¨™æº–æ¯”è¼ƒ
æ¡ä»¶ä»˜ãWebæ¤œç´¢ã‚’å«ã‚€ã€æ¥­ç•Œæ¨™æº–ã¨ã®æ¯”è¼ƒåˆ†æ
"""
import json
from typing import Dict, Any
# ========== ä¿®æ­£ç®‡æ‰€ï¼ˆã“ã“ã‹ã‚‰ï¼‰ ==========
# 1. ã¾ãš config ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from config import Config

# 2. æ¬¡ã« utils ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from utils import (
    call_openai_with_retry,
    parse_json_with_retry,
    validate_comparison_data,
    logger
)

# 3. æœ€å¾Œã« serpapi_utils ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ¡ä»¶ä»˜ãï¼‰
try:
    from serpapi_utils import execute_dual_search
    SERPAPI_AVAILABLE = True
except ImportError as e:
    logger.warning(f"serpapi_utils ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}")
    logger.warning("Webæ¤œç´¢æ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™")
    SERPAPI_AVAILABLE = False
    
    # ãƒ€ãƒŸãƒ¼é–¢æ•°ã‚’å®šç¾©
    def execute_dual_search(job_category: str) -> str:
        return "Webæ¤œç´¢ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚"
# ========== ä¿®æ­£ç®‡æ‰€ï¼ˆã“ã“ã¾ã§ï¼‰ ==========


def _build_step1_prompt(structured_data: Dict[str, Any], job_category: str) -> str:
    """
    Step 2-1ï¼ˆLLMå˜ä½“ã§ã®å®Ÿæ…‹æ¨å¯Ÿï¼‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
    
    Args:
        structured_data: ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘ ã®å‡ºåŠ›
        job_category: è·ç¨®å
        
    Returns:
        æ§‹ç¯‰ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    """
    prompt = f"""
ã‚ãªãŸã¯æ¡ç”¨ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ã€æ±‚äººæƒ…å ±ï¼ˆå†…å®¹Aï¼šæ±‚äººç¥¨ã®è¨˜è¿°ï¼‰ã€‘
{json.dumps(structured_data, ensure_ascii=False, indent=2)}

ã€è·ç¨®ã€‘
{job_category}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚ãªãŸã®ã‚¿ã‚¹ã‚¯ã€‘
ã“ã®æ±‚äººç¥¨ã®ã€ŒçœŸã®å§¿ï¼ˆå®Ÿæ…‹ï¼‰ã€ã‚’å…·ä½“çš„ãƒ»ãƒªãƒƒãƒã«æ¨å¯Ÿã—ã¦ãã ã•ã„ã€‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€é‡è¦ãªå‰æã€‘
- å†…å®¹A = æ±‚äººç¥¨ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã€Œæ–‡å­—é¢ã€ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ»æŠ½è±¡çš„ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰çš„ï¼‰
- å†…å®¹B = ã“ã®æ±‚äººã®ã€Œå®Ÿéš›ã®æ¥­å‹™å†…å®¹ã€ã‚’å…·ä½“çš„ã«æ¨å¯Ÿï¼ˆãƒªãƒƒãƒãƒ»è©³ç´°ãƒ»å®Ÿè·µçš„ï¼‰
- æ–°äººãƒªã‚¯ãƒ«ãƒ¼ã‚¿ãƒ¼ãŒå®Ÿæ…‹ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãã‚‹ã‚ˆã†ã€æ•°å€¤ãƒ»å…·ä½“ä¾‹ãƒ»èƒŒæ™¯ã‚’ç››ã‚Šè¾¼ã‚€

ã€å†…å®¹Bã®æ¨å¯ŸæŒ‡é‡ï¼ˆAâ†’Bã§ãƒªãƒƒãƒåŒ–ï¼‰ã€‘

### æ±‚äººç¥¨å
- ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¿ã‚¤ãƒˆãƒ« â†’ å…·ä½“çš„ãªè·ç¨®åï¼ˆè¦æ¨¡ãƒ»ç¯„å›²ãƒ»ç‰¹å¾´ã‚’å«ã‚ã‚‹ï¼‰
- ä¾‹ï¼šã€Œãƒãƒƒãƒ†ãƒªãƒ¼ãƒ‘ãƒƒã‚¯ã®è¨­è¨ˆ/ç ”ç©¶ã€
 - æ³¨æ„: æ±‚äººç¥¨ã«æ—¢ã«æ˜ç¢ºãª**è·ä½ï¼ˆå½¹å‰²åï¼‰**ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**è·ä½ã®èªå½™ï¼ˆå½¹è·åï¼‰ã¯æ±ºã—ã¦å¤‰æ›´ã—ãªã„ã§ãã ã•ã„**ã€‚
     è·ä½åã‚’å¤‰æ›´ã›ãšã«ã€ã‚ˆã‚Šå…·ä½“çš„ãªè·å‹™ç¯„å›²ã‚„ç®¡ç†è²¬ä»»ã¯åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆä¾‹: "æ±‚äººç¥¨åè£œè¶³" ã‚„ "å½¹å‰²è©³ç´°"ï¼‰ã¨ã—ã¦è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
 - ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¿ã‚¤ãƒˆãƒ« â†’ å…·ä½“çš„ãªè·ç¨®åï¼ˆè¦æ¨¡ãƒ»ç¯„å›²ãƒ»ç‰¹å¾´ã‚’å«ã‚ã‚‹ï¼‰
 - ä¾‹ï¼šã€Œãƒãƒƒãƒ†ãƒªãƒ¼ãƒ‘ãƒƒã‚¯ã®è¨­è¨ˆ/ç ”ç©¶ã€
     â†’ ã€Œæ¬¡ä¸–ä»£EVãƒã‚¤ã‚¯ç”¨ãƒªãƒã‚¦ãƒ ã‚¤ã‚ªãƒ³ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ‘ãƒƒã‚¯ã®è¨­è¨ˆãƒ»ç ”ç©¶ï¼ˆç®¡ç†è·å€™è£œãƒ»5-10åãƒãƒ¼ãƒ çµ±æ‹¬ï¼‰ã€

### æ¡ç”¨èƒŒæ™¯
- æ±‚äººç¥¨ã«è¨˜è¼‰ãŒãªã„å ´åˆã§ã‚‚ã€ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰æ¨å¯Ÿï¼ˆ200-300æ–‡å­—ï¼‰ï¼š
  * äº‹æ¥­æ‹¡å¤§ãƒ»æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç«‹ã¡ä¸Šã’ãªã©ã®çµ„ç¹”çš„èƒŒæ™¯
  * æŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰ã‚„å¸‚å ´å‹•å‘ã«åŸºã¥ãå¿…è¦æ€§
  * æ—¢å­˜ãƒãƒ¼ãƒ ã®èª²é¡Œï¼ˆäººå“¡ä¸è¶³ã€ã‚¹ã‚­ãƒ«ã‚®ãƒ£ãƒƒãƒ—ã€ä¸–ä»£äº¤ä»£ãªã©ï¼‰
  * æ¥­ç•Œä¸€èˆ¬è«–ã«åŸºã¥ãæ¡ç”¨å‹•æ©Ÿ
- ä¾‹ï¼šã€Œè¨˜è¼‰ãªã—ã€
  â†’ ã€Œé›»å‹•åŒ–åŠ é€Ÿã«ä¼´ã†æ¬¡ä¸–ä»£ãƒãƒƒãƒ†ãƒªãƒ¼é–‹ç™ºä½“åˆ¶ã®å¼·åŒ–ã€‚2025-2027å¹´ã«è¤‡æ•°ã®æ–°å‹EVæŠ•å…¥ã‚’è¨ˆç”»ã—ã¦ãŠã‚Šã€ç¾è¡Œãƒãƒ¼ãƒ ï¼ˆ15åç¨‹åº¦ï¼‰ã§ã¯å¯¾å¿œãŒå›°é›£ã€‚ç‰¹ã«é«˜ã‚¨ãƒãƒ«ã‚®ãƒ¼å¯†åº¦åŒ–ã¨æ€¥é€Ÿå……é›»æŠ€è¡“ã®å°‚é–€äººæãŒä¸è¶³ã€‚ç«¶åˆã®Yamaha/Kawasakiã‚‚åŒé ˜åŸŸã§æ¡ç”¨å¼·åŒ–ä¸­ã§ã€æ¥­ç•Œå…¨ä½“ã§äººæç²å¾—ç«¶äº‰ãŒæ¿€åŒ–ã—ã¦ã„ã‚‹èƒŒæ™¯ã€

### å½¹å‰²
- æŠ½è±¡çš„ãªå½¹å‰² â†’ å…·ä½“çš„ãªè²¬ä»»ç¯„å›²ï¼ˆãƒãƒ¼ãƒ è¦æ¨¡ã€äºˆç®—è¦æ¨¡ã€è£é‡ç¯„å›²ï¼‰
- çµ„ç¹”å†…ã§ã®ä½ç½®ã¥ã‘ï¼ˆèª°ã«å ±å‘Šã€èª°ã‚’å·»ãè¾¼ã‚€ã‹ï¼‰
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è²¬ä»»ç¯„å›²ï¼ˆæŠ€è¡“ã®ã¿ï¼Ÿäºˆç®—ã‚‚ï¼Ÿäººäº‹ã‚‚ï¼Ÿï¼‰
- ä¾‹ï¼šã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°(ç®¡ç†è·å€™è£œ)ã€
 - æ³¨æ„: **è·ä½ï¼ˆå½¹è·åï¼‰ãã®ã‚‚ã®ã¯å¤‰æ›´ã—ãªã„ã§ãã ã•ã„**ã€‚æ—¢å­˜ã®è·ä½åã¯ãã®ã¾ã¾ä¿æŒã—ã€è·å‹™å†…å®¹ã‚„è²¬ä»»ç¯„å›²ã®ã¿ã‚’å…·ä½“åŒ–ã—ã¦ãã ã•ã„ã€‚
 - æŠ½è±¡çš„ãªå½¹å‰² â†’ å…·ä½“çš„ãªè²¬ä»»ç¯„å›²ï¼ˆãƒãƒ¼ãƒ è¦æ¨¡ã€äºˆç®—è¦æ¨¡ã€è£é‡ç¯„å›²ã€è·éšï¼‰
 - çµ„ç¹”å†…ã§ã®ä½ç½®ã¥ã‘ï¼ˆèª°ã«å ±å‘Šã€èª°ã‚’å·»ãè¾¼ã‚€ã‹ï¼‰
 - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è²¬ä»»ç¯„å›²ï¼ˆæŠ€è¡“ã®ã¿ï¼Ÿäºˆç®—ã‚‚ï¼Ÿäººäº‹ã‚‚ï¼Ÿï¼‰
 - ä¾‹ï¼šã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°(ç®¡ç†è·å€™è£œ)ã€
     â†’ ã€Œãƒãƒƒãƒ†ãƒªãƒ¼é–‹ç™ºPJã®ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆ5-8åã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒãƒ¼ãƒ çµ±æ‹¬ã€å¹´é–“äºˆç®—3-5å„„å††è¦æ¨¡ã€æŠ€è¡“é¸å®šã‹ã‚‰é‡ç”£åŒ–ã¾ã§ä¸€æ°—é€šè²«ã§è²¬ä»»ã€‚éƒ¨é•·ã«é€±æ¬¡å ±å‘Šã€å››è¼ªéƒ¨é–€ã‚„èª¿é”éƒ¨é–€ã¨æœˆæ¬¡èª¿æ•´ä¼šè­°ï¼‰ã€

### æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹
- æ¥­å‹™ã®ç¾…åˆ— â†’ å„ã‚¹ãƒ†ãƒƒãƒ—ã®å…·ä½“çš„ãªå†…å®¹ï¼ˆæ‰€è¦æ™‚é–“ãƒ»é »åº¦ãƒ»å·¥æ•°ãƒ»é–¢ä¿‚è€…æ•°ï¼‰
- æˆæœç‰©ã®å…·ä½“ä¾‹ï¼ˆãƒšãƒ¼ã‚¸æ•°ã€ãƒ‡ãƒ¼ã‚¿é‡ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°ï¼‰
- ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¼šè­°ãªã©ã‚‚è¿½åŠ 
- å„ã‚¹ãƒ†ãƒƒãƒ—ã«â€»å°ã§æ„å‘³ã‚’ä¸€è¨€è£œè¶³
- ä¾‹ï¼š
  ```
  è¦æ±‚ä»•æ§˜ã®æ¤œè¨ã€ä½œæˆï¼ï¼ˆè¦æ±‚ä»•æ§˜æ›¸50-80ãƒšãƒ¼ã‚¸ï¼‰â€»å¸‚å ´èª¿æŸ»ã¨å››è¼ªéƒ¨é–€ã¨ã®æ•´åˆæ€§ç¢ºèªã‚’å«ã‚€
  â†“ï¼ˆæ‰€è¦æ™‚é–“ï¼š2-3ãƒ¶æœˆã€éƒ¨é–€æ¨ªæ–­ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¼šè­°3-4å›ï¼‰
  ãƒ‘ãƒƒã‚¯éƒ¨å“ã®ä»•æ§˜æ¤œè¨ã€è¨­è¨ˆï¼ï¼ˆ3D CADãƒ¢ãƒ‡ãƒ«ã€æ§‹é€ è§£æãƒ¬ãƒãƒ¼ãƒˆã€å›è·¯å›³ï¼‰â€»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–ã«1-2ãƒ¶æœˆã€FEAè§£æã§å¼·åº¦ãƒ»ç†±è§£æã‚’å®Ÿæ–½
  â†“ï¼ˆæ‰€è¦æ™‚é–“ï¼š3-4ãƒ¶æœˆã€é€±æ¬¡é€²æ—ä¼šè­°ï¼‰
  éƒ¨å“ã‚³ã‚¹ãƒˆã®ä¼ç”»ã€æ¤œè¨ï¼ï¼ˆã‚³ã‚¹ãƒˆä¼ç”»æ›¸ã€ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼æ¯”è¼ƒè¡¨ï¼‰â€»ç›®æ¨™ã‚³ã‚¹ãƒˆé”æˆã®ãŸã‚5-8ç¤¾ã¨äº¤æ¸‰
  â†“ï¼ˆæ‰€è¦æ™‚é–“ï¼š1-2ãƒ¶æœˆï¼‰
  ä»–éƒ¨é–€ã€ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ã¨ã®æŠ€è¡“æ¤œè¨ï¼ï¼ˆæŠ€è¡“æ¤œè¨å ±å‘Šæ›¸ã€ä»•æ§˜å¤‰æ›´ææ¡ˆæ›¸ï¼‰â€»é€±1-2å›ã®æ‰“ã¡åˆã‚ã›
  â†“ï¼ˆæ‰€è¦æ™‚é–“ï¼šç¶™ç¶šçš„ã€æœˆæ¬¡å®šä¾‹ä¼šè­°ï¼‰
  ã‚»ãƒ«/ãƒ‘ãƒƒã‚¯éƒ¨å“ã®ä»•æ§˜æ¤œè¨ã€ç ”ç©¶ï¼ï¼ˆè©¦é¨“è¨ˆç”»æ›¸ã€è©¦é¨“çµæœå ±å‘Šæ›¸ï¼‰â€»è€ä¹…è©¦é¨“ã¯3-6ãƒ¶æœˆã€å®‰å…¨æ€§è©¦é¨“ã¯å„ç¨®è¦æ ¼ã«æº–æ‹ 
  ```

### å¯¾è±¡è£½å“
- ã‚·ãƒ³ãƒ—ãƒ«ãªè£½å“å â†’ è©³ç´°ã‚¹ãƒšãƒƒã‚¯ï¼ˆæ•°å€¤ãƒ»æ€§èƒ½ãƒ»è¦æ¨¡ï¼‰
- æŠ€è¡“çš„ãªç‰¹å¾´ãƒ»é›£æ˜“åº¦
- å¸‚å ´ã§ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ»ç«¶åˆã¨ã®å·®åˆ¥åŒ–ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã‚’æ˜ç¤º
- é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºï¼ˆç ”ç©¶æ®µéšï¼Ÿè©¦ä½œï¼Ÿé‡ç”£æº–å‚™ï¼Ÿï¼‰
- ä¾‹ï¼šã€ŒäºŒè¼ªEVç”¨ãƒãƒƒãƒ†ãƒªãƒ¼ã€
  â†’ ã€ŒHondaæ¬¡ä¸–ä»£äºŒè¼ªEVç”¨ãƒªãƒã‚¦ãƒ ã‚¤ã‚ªãƒ³ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ‘ãƒƒã‚¯ï¼ˆå®¹é‡5-10kWhæƒ³å®šã€èˆªç¶šè·é›¢100-150kmç›®æ¨™ã€é‡é‡20-30kgã€é›»åœ§48V-72Væƒ³å®šï¼‰ã€‚ç¾åœ¨ã¯è©¦ä½œãƒ•ã‚§ãƒ¼ã‚ºã€2027-2028å¹´é‡ç”£é–‹å§‹ç›®æ¨™ã€‚å››è¼ªã¨ç•°ãªã‚Šè»½é‡åŒ–ãƒ»çœã‚¹ãƒšãƒ¼ã‚¹ãŒæœ€é‡è¦èª²é¡Œã€‚ç«¶åˆã¯Yamahaã€Kawasakiã‚‚é–‹ç™ºä¸­ã ãŒHondaã¯ä¸–ç•Œã‚·ã‚§ã‚¢35%ã®ãƒˆãƒƒãƒ—ãƒ¡ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦å…ˆè¡Œã‚’ç›®æŒ‡ã™ã€

### ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼
- é–¢ä¿‚è€…ã®ç¾…åˆ— â†’ å…·ä½“çš„ãªé–¢ä¿‚æ€§ï¼ˆé »åº¦ãƒ»äººæ•°ãƒ»å½¹è·ï¼‰
- ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•ï¼ˆä¼šè­°ä½“ã€å ±å‘Šé »åº¦ï¼‰
- å†…éƒ¨ãƒ»å¤–éƒ¨ã®åŒºåˆ¥
- ä¾‹ï¼šã€Œä»–éƒ¨é–€ï¼ˆCï¼‰ã€ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼ï¼ˆCï¼‰ã€
  â†’ ã€Œã€ç¤¾å†…ã€‘ç›´å±ä¸Šå¸ï¼šãƒãƒƒãƒ†ãƒªãƒ¼é–‹ç™ºéƒ¨é•·ï¼ˆRã€é€±æ¬¡1on1ï¼‰/ ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ï¼šã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢5-8åï¼ˆCã€æ—¥æ¬¡ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒƒãƒ—MTGï¼‰/ å››è¼ªãƒãƒƒãƒ†ãƒªãƒ¼éƒ¨é–€ï¼ˆCã€æœˆæ¬¡æŠ€è¡“äº¤æµä¼šï¼‰/ èª¿é”éƒ¨ï¼ˆCã€æœˆæ¬¡ã‚³ã‚¹ãƒˆèª¿æ•´ä¼šè­°ï¼‰/ å“è³ªä¿è¨¼éƒ¨ï¼ˆCã€ãƒ•ã‚§ãƒ¼ã‚ºã‚²ãƒ¼ãƒˆæ¯ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã€ç¤¾å¤–ã€‘ãƒãƒƒãƒ†ãƒªãƒ¼ã‚»ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼3-5ç¤¾ï¼ˆCã€é€±æ¬¡é€²æ—ä¼šè­°ï¼‰/ ææ–™ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼10-15ç¤¾ï¼ˆCã€æœˆæ¬¡æŠ€è¡“æ¤œè¨ä¼šï¼‰/ è¦æ ¼èªè¨¼æ©Ÿé–¢ï¼ˆIã€å¹´2-3å›ï¼‰ã€

### ä½¿ç”¨æŠ€è¡“
- æŠ€è¡“ã®ç¾…åˆ— â†’ å…·ä½“çš„ãªãƒ„ãƒ¼ãƒ«åãƒ»ä½¿ç”¨å ´é¢ãƒ»é »åº¦ãƒ»ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«
- è¦ç´ æŠ€è¡“ï¼ã‚¹ã‚­ãƒ«ãƒ»çµŒé¨“ï¼ãƒ„ãƒ¼ãƒ«åã®é †ã§å…·ä½“åŒ–
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ»ãƒ™ãƒ³ãƒ€ãƒ¼ã‚‚å¯èƒ½ãªé™ã‚Š
- ä¾‹ï¼šã€Œæ§‹é€ è§£æâ€»æ¨å¯Ÿã€å›è·¯è§£æâ€»æ¨å¯Ÿã€
  â†’ ã€Œã€è¨­è¨ˆãƒ„ãƒ¼ãƒ«ã€‘3D CADï¼ˆCATIA V5/V6ã¾ãŸã¯ NXã€æ¯æ—¥ä½¿ç”¨ã€ä¸Šç´šãƒ¬ãƒ™ãƒ«ï¼‰ã€è§£æãƒ„ãƒ¼ãƒ«ã€‘FEAæ§‹é€ è§£æï¼ˆANSYS Mechanicalã€é€±2-3å›ã€ä¸­ç´šä»¥ä¸Šï¼‰/ å›è·¯è§£æï¼ˆLTspiceã€é€±1-2å›ã€ä¸­ç´šï¼‰/ ç†±è§£æï¼ˆANSYS Fluentã€æœˆ2-3å›ã€ä¸­ç´šï¼‰ã€ãƒ‡ãƒ¼ã‚¿åˆ†æã€‘Excelï¼ˆãƒã‚¯ãƒ­ãƒ»VBAã€æ¯æ—¥ã€ä¸­ç´šï¼‰/ Pythonï¼ˆãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã€é€±1-2å›ã€åˆç´š-ä¸­ç´šï¼‰ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã€‘MS Project ã¾ãŸã¯ Jiraï¼ˆé€²æ—ç®¡ç†ã€æ¯æ—¥ã€ä¸­ç´šï¼‰ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‘Teamsã€PowerPointï¼ˆå ±å‘Šè³‡æ–™ä½œæˆã€é€±2-3å›ï¼‰ã€

### ãƒãƒªãƒ¥ãƒ¼ãƒã‚§ãƒ¼ãƒ³
- æ±‚äººç¥¨ã«è¨˜è¼‰ãŒãªã„å ´åˆã§ã‚‚ã€ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰æ¨å¯Ÿï¼ˆ200-300æ–‡å­—ï¼‰ï¼š
  * å…¨ç¤¾ãƒ¬ãƒ™ãƒ«ï¼šä¼æ¥­å…¨ä½“ã®ä¾¡å€¤å‰µé€ ã«ãŠã‘ã‚‹å½¹å‰²
  * äº‹æ¥­ãƒ¬ãƒ™ãƒ«ï¼šæ‹…å½“äº‹æ¥­ãƒ»éƒ¨é–€ã«ãŠã‘ã‚‹è²¢çŒ®
  * æ¥­ç•Œãƒ¬ãƒ™ãƒ«ï¼šæ¥­ç•Œå…¨ä½“ã«å¯¾ã™ã‚‹ä¾¡å€¤æä¾›
  * ã‚³ã‚¢ãƒãƒªãƒ¥ãƒ¼ï¼šã“ã®è·ç¨®ãŒæä¾›ã™ã‚‹æ ¸å¿ƒçš„ä¾¡å€¤
  * ãƒãƒªãƒ¥ãƒ¼ãƒã‚§ãƒ¼ãƒ³ä¸Šã®ä½ç½®ï¼šä¸Šæµ/ä¸­æµ/ä¸‹æµã®ã©ã“ã«ä½ç½®ã™ã‚‹ã‹
- ä¾‹ï¼šã€Œè¨˜è¼‰ãªã—ã€
  â†’ ã€Œã€å…¨ç¤¾ã€‘Hondaã®é›»å‹•åŒ–æˆ¦ç•¥ã®ä¸­æ ¸ã‚’æ‹…ã†ç ”ç©¶é–‹ç™ºï¼ˆR&Dä¸Šæµï¼‰ã€‚2030å¹´ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ç›®æ¨™é”æˆã«ç›´çµã€äº‹æ¥­ã€‘äºŒè¼ªäº‹æ¥­ã®æ¬¡ä¸–ä»£å‹•åŠ›æºé–‹ç™ºã€‚æ—¢å­˜ã‚¨ãƒ³ã‚¸ãƒ³æŠ€è¡“ã‹ã‚‰ã®è»¢æ›ã‚’æŠ€è¡“é¢ã§ãƒªãƒ¼ãƒ‰ã€æ¥­ç•Œã€‘äºŒè¼ªEVå¸‚å ´ã§ã®ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¸ã‚·ãƒ§ãƒ³ç¢ºç«‹ã€‚ç«¶åˆã«å…ˆé§†ã‘ãŸé«˜æ€§èƒ½ãƒãƒƒãƒ†ãƒªãƒ¼æŠ€è¡“ã®ç¢ºç«‹ã€ã‚³ã‚¢ãƒãƒªãƒ¥ãƒ¼ã€‘è»½é‡ãƒ»é«˜å®¹é‡ãƒ»å®‰å…¨æ€§ã‚’ä¸¡ç«‹ã™ã‚‹ãƒãƒƒãƒ†ãƒªãƒ¼æŠ€è¡“ã®é–‹ç™ºã€‚è£½å“å·®åˆ¥åŒ–ã®æºæ³‰ã€ä½ç½®ã¥ã‘ã€‘è¦ç´ æŠ€è¡“é–‹ç™ºï¼ˆä¸Šæµï¼‰â†’ ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆï¼ˆä¸­æµï¼‰â†’ é‡ç”£åŒ–ï¼ˆä¸‹æµï¼‰ã®ä¸Šæµã€œä¸­æµã‚’æ‹…å½“ã€

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚

{{
  "content_b": {{
    "æ±‚äººç¥¨å": "å…·ä½“çš„ãƒ»è©³ç´°ãƒ»ãƒªãƒƒãƒãªè·ç¨®åï¼ˆè¦æ¨¡ãƒ»ç¯„å›²å«ã‚€ï¼‰",
    "æ¡ç”¨èƒŒæ™¯": "äº‹æ¥­èƒŒæ™¯ã€çµ„ç¹”èª²é¡Œã€æŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰ã€æ¡ç”¨å‹•æ©Ÿã‚’200-300æ–‡å­—ã§æ¨å¯Ÿ",
    "å½¹å‰²": "å…·ä½“çš„ãªè²¬ä»»ç¯„å›²ï¼ˆãƒãƒ¼ãƒ è¦æ¨¡ã€äºˆç®—ã€çµ„ç¹”å†…ä½ç½®ã¥ã‘ã€è£é‡ç¯„å›²ã‚’æ˜è¨˜ï¼‰",
    "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹": "ãƒ—ãƒ­ã‚»ã‚¹Aï¼ï¼ˆå…·ä½“çš„ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼‰â€»æ„å‘³ã®ä¸€è¨€è£œè¶³\\nâ†“ï¼ˆæ‰€è¦æ™‚é–“ãƒ»é »åº¦ï¼‰\\nãƒ—ãƒ­ã‚»ã‚¹Bï¼ï¼ˆå…·ä½“çš„ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼‰â€»æ„å‘³ã®ä¸€è¨€è£œè¶³\\nâ†“\\n...",
    "å¯¾è±¡è£½å“": "è©³ç´°ã‚¹ãƒšãƒƒã‚¯ã€æ•°å€¤ã€æ€§èƒ½ã€é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã€å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ³ã€æŠ€è¡“çš„ç‰¹å¾´",
    "ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼": "ã€ç¤¾å†…ã€‘å…·ä½“çš„ãªéƒ¨ç½²ãƒ»å½¹è·ï¼ˆé–¢ä¿‚æ€§ã€é »åº¦ã€äººæ•°ï¼‰ã€ç¤¾å¤–ã€‘å–å¼•å…ˆãƒ»é–¢ä¿‚æ©Ÿé–¢ï¼ˆé–¢ä¿‚æ€§ã€é »åº¦ï¼‰",
    "ä½¿ç”¨æŠ€è¡“": "ã€ã‚«ãƒ†ã‚´ãƒªAã€‘ãƒ„ãƒ¼ãƒ«åï¼ˆä½¿ç”¨å ´é¢ã€é »åº¦ã€ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ï¼‰ã€ã‚«ãƒ†ã‚´ãƒªBã€‘ãƒ„ãƒ¼ãƒ«åï¼ˆ...ï¼‰",
    "ãƒãƒªãƒ¥ãƒ¼ãƒã‚§ãƒ¼ãƒ³": "å…¨ç¤¾ãƒ»äº‹æ¥­ãƒ»æ¥­ç•Œãƒ¬ãƒ™ãƒ«ã§ã®ä¾¡å€¤å‰µé€ ã€ã‚³ã‚¢ãƒãƒªãƒ¥ãƒ¼ã€ä¸Šæµ/ä¸­æµ/ä¸‹æµã®ä½ç½®ã¥ã‘ã‚’200-300æ–‡å­—ã§æ¨å¯Ÿ"
  }},
  "gap_analysis": {{
    "æ±‚äººç¥¨å": "ã€å·®ç•°ã€‘å†…å®¹Aã¯ã€‡ã€‡ã€å†…å®¹Bã¯â–³â–³\\n\\nã€ä¸è¶³æƒ…å ±ã€‘æ±‚äººç¥¨ã«æ›¸ã‹ã‚Œã¦ã„ãªã„æƒ…å ±ï¼ˆ2-3é …ç›®ï¼‰\\n\\nã€æ¡ç”¨éƒ¨é–€ã¸ã®ãƒ’ã‚¢ãƒªãƒ³ã‚°é …ç›®ã€‘\\n1. è³ªå•1\\n2. è³ªå•2\\n3. è³ªå•3",
    "æ¡ç”¨èƒŒæ™¯": "åŒæ§˜ã®å½¢å¼",
    "å½¹å‰²": "åŒæ§˜ã®å½¢å¼",
    "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹": "åŒæ§˜ã®å½¢å¼",
    "å¯¾è±¡è£½å“": "åŒæ§˜ã®å½¢å¼",
    "ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼": "åŒæ§˜ã®å½¢å¼",
    "ä½¿ç”¨æŠ€è¡“": "åŒæ§˜ã®å½¢å¼",
    "ãƒãƒªãƒ¥ãƒ¼ãƒã‚§ãƒ¼ãƒ³": "åŒæ§˜ã®å½¢å¼"
  }},
  "confidence_score": 0.0-1.0,
  "uncertain_aspects": ["ä¸ç¢ºå®Ÿãªé …ç›®1", "ä¸ç¢ºå®Ÿãªé …ç›®2"],
  "reasoning": "ã“ã®æ¨å¯Ÿã®æ ¹æ‹ ï¼ˆæ±‚äººç¥¨ã®ã©ã®éƒ¨åˆ†ã‹ã‚‰ã€ä¼šç¤¾ã®ä½•ã‹ã‚‰æ¨å¯Ÿã—ãŸã‹ï¼‰"
}}

ã€ã‚®ãƒ£ãƒƒãƒ—åˆ†æã®å¿…é ˆæ§‹æˆã€‘
å„é …ç›®ã§ä»¥ä¸‹ã®3è¦ç´ ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ï¼š

**ã€å·®ç•°ã€‘** 1-2æ–‡ã§ç°¡æ½”ã«
å†…å®¹Aï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰çš„ï¼‰ã¨å†…å®¹Bï¼ˆãƒªãƒƒãƒãƒ»å…·ä½“çš„ï¼‰ã®é•ã„ã‚’ç«¯çš„ã«è¨˜è¿°

**ã€ä¸è¶³æƒ…å ±ã€‘** 2-3é …ç›®
æ±‚äººç¥¨ã«æ›¸ã‹ã‚Œã¦ã„ãªã„ãŒã€é‡è¦ãªæƒ…å ±ã¯ä½•ã‹
- æ¥­å‹™ã®è©³ç´°ï¼ˆç¯„å›²ã€æ¯”é‡ã€æœŸé–“ã€å·¥æ•°ãªã©ï¼‰
- çµ„ç¹”æƒ…å ±ï¼ˆãƒãƒ¼ãƒ è¦æ¨¡ã€äºˆç®—è¦æ¨¡ã€å ±å‘Šå…ˆãªã©ï¼‰
- æŠ€è¡“ãƒ»è£½å“æƒ…å ±ï¼ˆå…·ä½“çš„ãªä»•æ§˜ã€ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã€å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã©ï¼‰

**ã€æ¡ç”¨éƒ¨é–€ã¸ã®ãƒ’ã‚¢ãƒªãƒ³ã‚°é …ç›®ã€‘** 3-5å€‹ã®è³ªå•
â€»æ³¨æ„ï¼šãƒ’ã‚¢ãƒªãƒ³ã‚°å…ˆã¯ã€Œæ¡ç”¨æ‹…å½“è€…ã€ã§ã¯ãªãã€Œæ¡ç”¨éƒ¨é–€ï¼ˆé…å±å…ˆã®ç¾å ´ï¼‰ã€ã§ã™

ã€è‰¯ã„ãƒ’ã‚¢ãƒªãƒ³ã‚°è³ªå•ã®ä½œã‚Šæ–¹ã€‘
âŒ NG: æŠ½è±¡çš„ãªè³ªå•
  - ã€Œè©³ç´°ã¯ï¼Ÿã€ã€Œå…·ä½“çš„ã«ã¯ï¼Ÿã€ã€Œã©ã®ãã‚‰ã„ã§ã™ã‹ï¼Ÿã€

âœ… OK: æ•°å€¤ãƒ»å›ºæœ‰åè©ãƒ»æ™‚æœŸãƒ»é »åº¦ã‚’èãå…·ä½“çš„ãªè³ªå•
  - ã€Œã“ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ãŒçµ±æ‹¬ã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ä½•åã‹ï¼Ÿã€
  - ã€Œå¹´é–“ã®ç ”ç©¶é–‹ç™ºäºˆç®—ã¯ã„ãã‚‰ã‹ï¼Ÿã€
  - ã€Œãƒãƒƒãƒ†ãƒªãƒ¼å®¹é‡ã®æƒ³å®šãƒ¬ãƒ³ã‚¸ã¯ï¼Ÿï¼ˆkWhå˜ä½ï¼‰ã€
  - ã€Œç¾åœ¨ã¯åŸºç¤ç ”ç©¶/è©¦ä½œ/é‡ç”£æº–å‚™ã®ã©ã®æ®µéšã‹ï¼Ÿã€
  - ã€Œã„ã¤é ƒã®å¸‚å ´æŠ•å…¥ã‚’ç›®æ¨™ã¨ã—ã¦ã„ã‚‹ã‹ï¼Ÿã€
  - ã€Œå„ç¨®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨é »åº¦ã¯ï¼Ÿï¼ˆæ—¥æ¬¡/é€±æ¬¡/æœˆæ¬¡ï¼‰ã€
  - ã€Œå¿…è¦ãªã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã¯ï¼Ÿï¼ˆåˆç´š/ä¸­ç´š/ä¸Šç´šï¼‰ã€

ã€è³ªå•ã®å„ªå…ˆé †ä½ã€‘
1. æ•°å€¤ã‚’èãè³ªå•ï¼ˆäººæ•°ã€é‡‘é¡ã€å®¹é‡ã€æœŸé–“ï¼‰
2. å›ºæœ‰åè©ã‚’èãè³ªå•ï¼ˆå…·ä½“çš„ãªãƒ„ãƒ¼ãƒ«åã€è£½å“åã€éƒ¨ç½²åï¼‰
3. æ™‚æœŸã‚’èãè³ªå•ï¼ˆé–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã€å¸‚å ´æŠ•å…¥æ™‚æœŸï¼‰
4. é »åº¦ãƒ»æ¯”é‡ã‚’èãè³ªå•ï¼ˆä½¿ç”¨é »åº¦ã€æ¥­å‹™æ¯”é‡ï¼‰

ã€è‡ªä¿¡åº¦è©•ä¾¡ã®åŸºæº–ã€‘
ã“ã®æ±‚äººã®å®Ÿæ…‹ã‚’æ¨å¯Ÿã§ããŸç¢ºä¿¡åº¦ã‚’0.0-1.0ã§è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š
- 0.9-1.0: éå¸¸ã«é«˜ã„ç¢ºä¿¡ï¼ˆæ±‚äººç¥¨ã®è¨˜è¿°ãŒè©³ç´°ã§ã€å…·ä½“çš„ãªæ¨å¯ŸãŒå¯èƒ½ï¼‰
- 0.7-0.8: é«˜ã„ç¢ºä¿¡ï¼ˆæ±‚äººç¥¨+ä¼šç¤¾æƒ…å ±ã‹ã‚‰å¦¥å½“ãªæ¨å¯ŸãŒå¯èƒ½ï¼‰
- 0.5-0.6: ä¸­ç¨‹åº¦ï¼ˆéƒ¨åˆ†çš„ã«æ¨å¯Ÿå¯èƒ½ã€ä¸€éƒ¨ã¯æ¥­ç•ŒçŸ¥è­˜ã«åŸºã¥ãä»®èª¬ï¼‰
- 0.3-0.4: ä½ã„ç¢ºä¿¡ï¼ˆæƒ…å ±ä¸è¶³ã§æ¨æ¸¬ã«é ¼ã‚‹éƒ¨åˆ†ãŒå¤šã„ï¼‰
- 0.0-0.2: ã»ã¼æ¨æ¸¬ï¼ˆç¢ºå®Ÿãªæƒ…å ±ãŒã»ã¨ã‚“ã©ãªã„ï¼‰

ã€é‡è¦ãªæ³¨æ„ã€‘
- å†…å®¹Bã¯ã€Œã“ã®æ±‚äººã®å®Ÿæ…‹äºˆæ¸¬ã€ã§ã‚ã‚Šã€æ•°å€¤ãƒ»å…·ä½“ä¾‹ãƒ»èƒŒæ™¯ã‚’è±Šå¯Œã«å«ã‚ã‚‹
- æ¨å¯Ÿã«ã¯å¿…ãšæ ¹æ‹ ã‚’ï¼ˆæ±‚äººç¥¨ã®è¡¨ç¾ã€ä¼šç¤¾ã®è¦æ¨¡ã€è·ç¨®ã®ç‰¹æ€§ã‹ã‚‰ï¼‰
- ã€Œã€‡ã€‡ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€ã§çµ‚ã‚ã‚‰ãšã€ãƒ’ã‚¢ãƒªãƒ³ã‚°é …ç›®ã§å…·ä½“çš„ãªç¢ºèªäº‹é …ã‚’ç¤ºã™

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å‡ºåŠ›æŒ‡ç¤ºã€‘
å¿…ãšä¸Šè¨˜ã®JSONå½¢å¼ã®ã¿ã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚
ä»–ã®æ–‡ç« ã€èª¬æ˜ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚
JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

â­â­â­ é‡è¦: content_bã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯å¿…ãš8é …ç›®ã™ã¹ã¦ã‚’å«ã‚ã¦ãã ã•ã„ â­â­â­
â­â­â­ é‡è¦: gap_analysisã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚‚å¿…ãš8é …ç›®ã™ã¹ã¦ã‚’å«ã‚ã¦ãã ã•ã„ â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    return prompt


def _build_step3_prompt(
    comparison_v1: Dict[str, Any],
    web_context: str
) -> str:
    """
    Step 2-3ï¼ˆWebæƒ…å ±çµ±åˆï¼‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
    
    Args:
        comparison_v1: Step 2-1ã®å‡ºåŠ›
        web_context: Webæ¤œç´¢çµæœ
        
    Returns:
        æ§‹ç¯‰ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    """
    prompt = f"""
ã€ã‚ãªãŸã®åˆå›å‡ºåŠ›ã€‘
{json.dumps(comparison_v1, ensure_ascii=False, indent=2)}

ã€Webæ¤œç´¢ã§å¾—ãŸè¿½åŠ æƒ…å ±ã€‘
{web_context}

ã€ã‚¿ã‚¹ã‚¯ã€‘
Webæ¤œç´¢ã§å¾—ãŸæƒ…å ±ã‚’å‚è€ƒã«ã€ã‚ˆã‚Šæ­£ç¢ºãªå†…å®¹Bï¼ˆå®Ÿæ…‹æ¨å¯Ÿï¼‰ãƒ»ã‚®ãƒ£ãƒƒãƒ—åˆ†æã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€æŒ‡ç¤ºã€‘
1. åˆå›å‡ºåŠ›ã§ä¸ç¢ºå®Ÿã ã£ãŸé …ç›®ï¼ˆuncertain_aspectsï¼‰ã‚’é‡ç‚¹çš„ã«æ”¹å–„
2. Webæƒ…å ±ã¨åˆå›å‡ºåŠ›ãŒçŸ›ç›¾ã™ã‚‹å ´åˆã€Webæƒ…å ±ã‚’å„ªå…ˆ
3. Webæƒ…å ±ã§æ–°ãŸã«åˆ†ã‹ã£ãŸå…·ä½“çš„ãªå®Ÿæ…‹ãƒ»æŠ€è¡“ãƒ»è£½å“æƒ…å ±ã‚’è¿½åŠ 
4. è‡ªä¿¡åº¦ã‚¹ã‚³ã‚¢ã‚’å†è©•ä¾¡ï¼ˆé€šå¸¸ã¯ä¸Šæ˜‡ã™ã‚‹ã¯ãšï¼‰
5. ä¾ç„¶ã¨ã—ã¦ä¸ç¢ºå®Ÿãªé …ç›®ãŒã‚ã‚Œã°ã€æ­£ç›´ã«uncertain_aspectsã«æ®‹ã™

ã€é‡è¦ã€‘
- Webæƒ…å ±ã‚’éµœå‘‘ã¿ã«ã›ãšã€ä¿¡é ¼æ€§ã‚’åˆ¤æ–­ã™ã‚‹
- SEOç›®çš„ã®ä½å“è³ªãªæƒ…å ±ã¯é™¤å¤–
- è¤‡æ•°ã‚½ãƒ¼ã‚¹ã§ç¢ºèªã§ãã‚‹æƒ…å ±ã‚’å„ªå…ˆ
- å†…å®¹Bã¯ã€Œã“ã®æ±‚äººã®å®Ÿæ…‹æ¨å¯Ÿã€ã§ã‚ã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„

ã€ã‚®ãƒ£ãƒƒãƒ—åˆ†æã®æ§‹æˆï¼ˆå†ç¢ºèªï¼‰ã€‘
å„é …ç›®ã§ä»¥ä¸‹ã®3è¦ç´ ã‚’å¿…ãšå«ã‚ã‚‹ï¼š

**ã€å·®ç•°ã€‘** 1-2æ–‡
**ã€ä¸è¶³æƒ…å ±ã€‘** 2-3é …ç›®
**ã€æ¡ç”¨éƒ¨é–€ã¸ã®ãƒ’ã‚¢ãƒªãƒ³ã‚°é …ç›®ã€‘** 3-5å€‹ã®è³ªå•

ã€å‡ºåŠ›å½¢å¼ã€‘
åˆå›å‡ºåŠ›ã¨åŒã˜JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚

{{
  "content_b": {{...}},
  "gap_analysis": {{
    "å„é …ç›®": "ã€å·®ç•°ã€‘...\\n\\nã€ä¸è¶³æƒ…å ±ã€‘...\\n\\nã€æ¡ç”¨éƒ¨é–€ã¸ã®ãƒ’ã‚¢ãƒªãƒ³ã‚°é …ç›®ã€‘\\n1. ...\\n2. ...\\n3. ..."
  }},
  "confidence_score": 0.0-1.0,
  "uncertain_aspects": [...],
  "reasoning": "Webæƒ…å ±ã‚’çµ±åˆã—ãŸçµæœã€ã€‡ã€‡ãŒæ”¹å–„ã•ã‚ŒãŸãŸã‚ã€è‡ªä¿¡åº¦ãŒâ–³â–³ã‹ã‚‰â–¡â–¡ã«ä¸Šæ˜‡ã€‚ä¾ç„¶ã¨ã—ã¦Ã—Ã—ã¯ä¸æ˜ã€‚"
}}
"""
    return prompt


def _step1_llm_only_comparison(
    structured_data: Dict[str, Any],
    job_category: str
) -> Dict[str, Any]:
    """
    Step 2-1: LLMå˜ä½“ã§ã®å®Ÿæ…‹æ¨å¯Ÿç”Ÿæˆ
    
    Args:
        structured_data: ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘ ã®å‡ºåŠ›
        job_category: è·ç¨®å
        
    Returns:
        åˆå›ã®æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
    """
    logger.info("Step 2-1: LLMå˜ä½“ã§ã®å®Ÿæ…‹æ¨å¯Ÿç”Ÿæˆ é–‹å§‹")
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
    prompt = _build_step1_prompt(structured_data, job_category)
    
    # ========== è¿½åŠ ç®‡æ‰€ï¼ˆã“ã“ã‹ã‚‰ï¼‰ ==========
    logger.info(f"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·: {len(prompt)} æ–‡å­—")
    logger.info(f"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å…ˆé ­500æ–‡å­—: {prompt[:500]}")
    # ========== è¿½åŠ ç®‡æ‰€ï¼ˆã“ã“ã¾ã§ï¼‰ ==========

    # ========== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨ä½“ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆè¿½åŠ ï¼‰ ==========
    logger.debug(f"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨ä½“: {prompt}")  # DEBUGãƒ¬ãƒ™ãƒ«ã§è¨˜éŒ²
    # ========================================================


    # LLMå‘¼ã³å‡ºã—
    response_text = call_openai_with_retry(
        prompt=prompt,
        temperature=1,  # ä¿®æ­£: ãƒ¢ãƒ‡ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«å¤‰æ›´
        max_completion_tokens=Config.MAX_TOKENS_LAYER2 + 3000
    )

    # ========== è¿½åŠ ç®‡æ‰€ï¼ˆã“ã“ã‹ã‚‰ï¼‰ ==========
    logger.info(f"å¿œç­”æ–‡å­—æ•°: {len(response_text)}")
    logger.info(f"å¿œç­”å†…å®¹ï¼ˆå…¨ä½“ï¼‰: {response_text}")  # å¿œç­”å†…å®¹ã®å…¨ä½“ã‚’è¨˜éŒ²
    # ========== è¿½åŠ ç®‡æ‰€ï¼ˆã“ã“ã¾ã§ï¼‰ ==========


    # JSONè§£æ
    comparison_v1 = parse_json_with_retry(response_text)
    
    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    validate_comparison_data(comparison_v1)
    
    logger.info(f"Step 2-1å®Œäº†: è‡ªä¿¡åº¦={comparison_v1['confidence_score']:.2f}")
    
    return comparison_v1


def _step3_web_integration(
    comparison_v1: Dict[str, Any],
    web_context: str
) -> Dict[str, Any]:
    """
    Step 2-3: Webæƒ…å ±çµ±åˆãƒ»å†ç”Ÿæˆ
    
    Args:
        comparison_v1: Step 2-1ã®å‡ºåŠ›
        web_context: Webæ¤œç´¢çµæœ
        
    Returns:
        çµ±åˆå¾Œã®æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
    """
    logger.info("Step 2-3: Webæƒ…å ±çµ±åˆãƒ»å†ç”Ÿæˆ é–‹å§‹")
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
    prompt = _build_step3_prompt(comparison_v1, web_context)
    
    # LLMå‘¼ã³å‡ºã—
    response_text = call_openai_with_retry(
        prompt=prompt,
        temperature=1, 
        max_completion_tokens=Config.MAX_TOKENS_LAYER2 + 1500
    )
    
    # JSONè§£æ
    comparison_v2 = parse_json_with_retry(response_text)
    
    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    validate_comparison_data(comparison_v2)
    
    logger.info(f"Step 2-3å®Œäº†: æ›´æ–°å¾Œè‡ªä¿¡åº¦={comparison_v2['confidence_score']:.2f}")
    
    return comparison_v2


def layer2_build_comparison_smart(
    structured_data: Dict[str, Any],
    job_category: str
) -> Dict[str, Any]:
    """
    ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘¡: æ¥­ç•Œæ¨™æº–æ¯”è¼ƒï¼ˆæ¡ä»¶ä»˜ãWebæ¤œç´¢ï¼‰
    
    Args:
        structured_data: ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘ ã®å‡ºåŠ›
        job_category: è·ç¨®å
        
    Returns:
        æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ï¼ˆcontent_b, gap_analysis, confidence_scoreç­‰ã‚’å«ã‚€ï¼‰
        
    Raises:
        Exception: æ¯”è¼ƒç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆ
    """
    logger.info("=" * 60)
    logger.info("ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘¡: å®Ÿæ…‹æ¨å¯Ÿãƒ»ã‚®ãƒ£ãƒƒãƒ—åˆ†æ é–‹å§‹")
    logger.info(f"è·ç¨®: {job_category}")
    
    try:
        # Step 2-1: LLMå˜ä½“ã§ã®å®Ÿæ…‹æ¨å¯Ÿ
        comparison_v1 = _step1_llm_only_comparison(structured_data, job_category)
        
        confidence_score = comparison_v1["confidence_score"]
        threshold = Config.CONFIDENCE_THRESHOLD
        uncertain_aspects = comparison_v1.get("uncertain_aspects", [])
        
        # Step 2-2: Webæ¤œç´¢ã®åˆ¤æ–­ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼‰
        should_search_web = False
        search_reason = ""
        
        # æ¡ä»¶1: ç‰¹å®šé …ç›®ã®ä¸ç¢ºå®Ÿæ€§ãƒã‚§ãƒƒã‚¯
        priority_items = ["å¯¾è±¡è£½å“", "ä½¿ç”¨æŠ€è¡“", "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹"]
        uncertain_priority_items = [item for item in uncertain_aspects
                                     if any(p in item for p in priority_items)]
        
        if uncertain_priority_items:
            should_search_web = True
            search_reason = f"é‡è¦é …ç›®ã«ä¸ç¢ºå®Ÿæ€§ã‚ã‚Š: {', '.join(uncertain_priority_items)}"
        
        # æ¡ä»¶2: è‡ªä¿¡åº¦ãŒé–¾å€¤æœªæº€
        elif confidence_score < threshold:
            should_search_web = True
            search_reason = f"è‡ªä¿¡åº¦ {confidence_score:.2f} < é–¾å€¤ {threshold:.2f}"
        
        # Webæ¤œç´¢å®Ÿè¡Œ
        if should_search_web:
            logger.info(f"ğŸ” Webæ¤œç´¢ã‚’å®Ÿè¡Œ: {search_reason}")
            
            # Webæ¤œç´¢å®Ÿè¡Œ
            web_context = execute_dual_search(job_category)
            
            # Step 2-3: Webæƒ…å ±çµ±åˆ
            comparison_final = _step3_web_integration(comparison_v1, web_context)
            comparison_final["web_search_performed"] = True
            
            logger.info(
                f"Webæ¤œç´¢å¾Œã®è‡ªä¿¡åº¦: {comparison_v1['confidence_score']:.2f} â†’ "
                f"{comparison_final['confidence_score']:.2f} "
                f"(å¤‰åŒ–: {comparison_final['confidence_score'] - comparison_v1['confidence_score']:+.2f})"
            )
            
        else:
            logger.info(
                f"âœ… è‡ªä¿¡åº¦ {confidence_score:.2f} >= é–¾å€¤ {threshold:.2f} "
                f"ã‹ã¤é‡è¦é …ç›®ã«ä¸ç¢ºå®Ÿæ€§ãªã— â†’ Webæ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—"
            )
            comparison_final = comparison_v1
            comparison_final["web_search_performed"] = False
        
        # content_aã‚’è¿½åŠ 
        comparison_final["content_a"] = structured_data
        
        logger.info("ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘¡: å®Ÿæ…‹æ¨å¯Ÿãƒ»ã‚®ãƒ£ãƒƒãƒ—åˆ†æ å®Œäº†")
        logger.info(f"æœ€çµ‚è‡ªä¿¡åº¦: {comparison_final['confidence_score']:.2f}")
        logger.info(f"Webæ¤œç´¢å®Ÿè¡Œ: {comparison_final['web_search_performed']}")
        logger.info("=" * 60)
        
        return comparison_final
        
    except Exception as e:
        logger.error(f"ãƒ¬ã‚¤ãƒ¤ãƒ¼â‘¡ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {str(e)}")
        raise Exception(f"å®Ÿæ…‹æ¨å¯Ÿãƒ»ã‚®ãƒ£ãƒƒãƒ—åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}")
